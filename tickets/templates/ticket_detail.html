{% extends "mbtbase.html" %}
{% load static %}
{% load meta_tags %}

{% block extra_meta %}
    {% meta_description "{{ ticket.ticket_type.type_name }} Ticket - Opened By: {{ ticket.user.username }} - On {{ ticket.created_at|date:'F j, Y' }}" %}
    {% meta_keywords "{{ ticket.ticket_type.type_name }}, ticket, support" %}
    {% meta_title "Ticket #{{ ticket.id }} - {{ ticket.ticket_type.type_name }} Ticket" %}
    {% meta_url "https://www.mybustimes.cc/tickets/{{ ticket.id }}/" %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
small {
  opacity: 0.5;
  margin-top: 2.5px;
  margin-left: 5px;
}
span {
  display: inline-flex;
}

p {
  margin-top: -1em;
}

img {
  margin-top: -10px;
  margin-bottom: 15px;
  max-height: 200px;
  max-width: 100%;
  object-fit: contain;
}

#menu-toggle {
  margin-top: 13px;
}

@media (min-width: 500px) {
  #message-form {
    margin-bottom: -33px;
  }
}

@media (min-width: 48em) {
  .pane {
    width: calc(50% - 10px);
  }

  .panes {
    justify-content: space-between;
    display: flex;
  }
}

</style>
{% endblock %}

{% block title %}Ticket #{{ ticket.id }}{% endblock %}

{% block content %}
<div>
  <h2>Ticket #{{ ticket.id }}</h2>
  <p><strong>Created:</strong> {{ ticket.created_at }}</p>
  <p><strong>Type:</strong> {{ ticket.ticket_type.type_name }}</p>
  <p><strong>Status:</strong> {{ ticket.get_status_display }}</p>

  {% if is_admin %}
  <br>
  <form action="" method="post">
    {% csrf_token %}
    <p><strong>Priority:</strong>
      <select name="priority" id="priority" onchange="this.form.submit()">
        <option value="low" {% if ticket.priority == "low" %}selected{% endif %}>Low</option>
        <option value="medium" {% if ticket.priority == "medium" %}selected{% endif %}>Medium</option>
        <option value="high" {% if ticket.priority == "high" %}selected{% endif %}>High</option>
        <option value="urgent" {% if ticket.priority == "urgent" %}selected{% endif %}>Urgent</option>
      </select>
    </p>
  </form>
  {% endif %}

  <hr>

  <h3>Messages</h3>
  <div id="messages">
    {% for message in ticket.messages.all %}
      <div>
        <span>{% if message.username %}{{ message.username }}{% else %}{{ message.sender }}{% endif %} <small>{{ message.created_at|date:"H:i" }}</small></span>
        <p>{{ message.content }}</p>
        {% if message.files %}
        <img src="/media/{{ message.files }}" alt="">
        {% endif %}
      </div>
    {% empty %}
      <p>No messages yet.</p>
    {% endfor %}
  </div>

  <form id="message-form" class="fleet-edit-wrapper" enctype="multipart/form-data">
      {% csrf_token %}
      <textarea id="message-content" name="content" rows="3" placeholder="{% if is_closed %}Ticket Closed{% else %}Type your message...{% endif %}" {% if is_closed %}disabled{% endif %}></textarea>
      <input id="message-file" type="file" name="file" {% if is_closed %}disabled{% endif %}><br><br>
      <button id="message-submit" class="btn" type="submit" {% if is_closed %}disabled{% endif %}>Send</button>
  </form>
  {% if is_admin and not is_closed %}
    <form action="{% url 'ticket_close' ticket.id %}" method="post">
      {% csrf_token %}
      <button class="btn delete-btn">Close</button>
    </form>
  {% endif %}
</div>

<script>
function fetchMessages() {
    fetch("{% url 'ticket_messages_api' ticket.id %}")
        .then(response => response.json())
        .then(data => {
            const info = data.info[0];
            const priority = info.priority;
            const status = info.status;

            if (status === "Closed") {
                document.getElementById("message-content").placeholder = "Ticket Closed";
                document.getElementById("message-content").disabled = true;
                document.getElementById("message-file").disabled = true;
                document.getElementById("message-submit").disabled = true;
            } else {
                document.getElementById("message-content").placeholder = "Type your message...";
                document.getElementById("message-content").disabled = false;
                document.getElementById("message-file").disabled = false;
                document.getElementById("message-submit").disabled = false;
            }

            const container = document.getElementById("messages");
            container.innerHTML = "";
            data.messages.forEach(msg => {
                const div = document.createElement("div");
                div.className = "mb-3 p-3 border rounded bg-gray-50";
                div.innerHTML = `<span class="text-sm text-gray-600">${msg.sender} <small>${msg.created_at}</small></span>
                  <p>${msg.content}</p>
                  ${msg.files ? `<img src="${msg.files}" >` : ''}`;
                container.appendChild(div);
            });
        });
}

// Poll for new messages every 3 seconds
setInterval(fetchMessages, 3000);

document.getElementById("message-form").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'ticket_messages_api' ticket.id %}", {
        method: "POST",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData
    }).then(() => {
        this.reset();
        fetchMessages();
    });
});
</script>
{% endblock %}
