{% extends 'mbtbase.html' %}
{% load static %}

{% block title %}Edit Vehicle Details{% endblock %}

{% block content %}

{# Assign liveryID variable: fleetData.livery.id if exists else 1 #}
{% with liveryID=fleetData.livery.id|default:1 %}
<style>
  .livery-cell {
    margin-right: 5px;
  }
</style>


<div class="fleet-edit-wrapper">
  <h1>Vehicle Specs</h1>

  <form action="" method="POST">
    {% csrf_token %}
    <input type="hidden" id="user" name="user" value="{{ userData.0.id }}"><br>

    <label for="in_service">In Service:</label>
    <input type="checkbox" id="in_service" name="in_service" {% if fleetData.in_service %}checked{% endif %}><br>

    <label for="preserved">Preserved:</label>
    <input type="checkbox" id="preserved" name="preserved" {% if fleetData.preserved %}checked{% endif %}><br><br>

    <label for="number_of_vehicles">Number of Vehicles:</label>
    <input type="number" name="number_of_vehicles" id="number_of_vehicles" value="1" min="1" required>

    <div id="vehicle-details-container">
    <br><label>Enter Fleet Number and Registration for Each Vehicle</label><br><br>
    <table id="vehicle-table" class="fleet" border="0" cellpadding="10" cellspacing="0" style="width: 100%;border: 1px solid var(--border-color);border-radius: .5em;">
        <thead>
        <tr>
            <th>Fleet Number <button type="button" id="autofill-btn">Auto Fill</button></th>
            <th>Reg <button type="button" id="autofill-reg-btn">Auto Fill</button></th>
        </tr>
        </thead>
        <tbody>
        <!-- JS will populate rows -->
        </tbody>
    </table>
    </div>
    <br>
    <label for="operator">Operator:</label>
    <select name="operator" id="operator" required>
      {% for operator in operatorData %}
      <option value="{{ operator.id }}" {% if operator.id == operator_current.id %}selected{% endif %}>
        {{ operator.operator_name }}
      </option>
      {% endfor %}
    </select>
    <small>This only needs to change for permanent transfers, not for short-term loans to another depot</small>

    <label for="loan_operator">Loan Operator:</label>
    <select name="loan_operator" id="loan_operator" required>
      <option value="null" {% if not fleetData.loan_operator %}selected{% endif %}>None</option>
      {% for operator in operatorData %}
      <option value="{{ operator.id }}" {% if fleetData.loan_operator and operator.id == fleetData.loan_operator.id %}selected{% endif %}>
        {{ operator.operator_name }}
      </option>
      {% endfor %}
    </select>
    <small>This only needs to change for temporary transfers, short-term loans only</small>

    <label for="type">Type:</label>
    <select name="type" id="type">
      {% for type in typeData %}
      <option value="{{ type.id }}" {% if type.id == fleetData.vehicle_type_data.id %}selected{% endif %}>
        {{ type.type_name }}
      </option>
      {% endfor %}
    </select>
    <input style="margin-top: -.5em;border-radius: 0;" type="text" id="type_details" placeholder="Additional Type Details" name="type_details" value="{{ fleetData.type_details }}" title="This is for things such as `Electric Conversion`">
    <input style="margin-top: -.5em; border-radius: 0 0 .5em .5em;" type="text" inputmode="decimal" id="length" name="length" value="{{ fleetData.length|default_if_none:'' }}" placeholder="Length" pattern="^\d{1,2}(\.\d{0,3})?$" title="Format: xx.xxx (e.g., 12.345 or 12.3)">
    <label style="margin-left: .5em;" for="open_top">Open Top:</label>
    <input type="checkbox" id="open_top" name="open_top" {% if fleetData.open_top %}checked{% endif %}><br><br>

    <label for="livery">Livery:</label>
    <select name="livery" id="livery">
      {% for livery in liveryData %}
      <option value="{{ livery.id }}" data-left_css="{{ livery.left_css }}" {% if livery.id == liveryID %}selected{% endif %}>
        {{ livery.name }}
      </option>
      {% endfor %}
    </select>

    <script>
      document.getElementById('length').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^\d.]/g, '');

        if (this.value.length > 6) {
          this.value = this.value.slice(0, 6);
        }

        const match = this.value.match(/^(\d{0,2})(\.?)(\d{0,3})/);
        if (match) {
          this.value = match[1] + match[2] + match[3];
        }

        if (this.value.trim() !== '') {
          const pattern = new RegExp(this.getAttribute('pattern'));
          if (pattern && !pattern.test(this.value)) {
            this.setCustomValidity('Invalid format. Please use xx.xxx (e.g., 12.345 or 12.3)');
          } else {
            this.setCustomValidity('');
          }
        } else {
          this.setCustomValidity('');
        }
      });
    </script>


    <label for="colour">Colour:</label>
    <input type="text" id="colour" placeholder="Colour" name="colour" value="{{ fleetData.colour }}">

    <label for="branding">Branding:</label>
    <input type="text" id="branding" placeholder="Branding" name="branding" value="{{ fleetData.branding }}">

    <label for="depot">Depot:</label>
    <input type="text" id="depot" placeholder="Depot" name="depot" value="{{ fleetData.depot|default:'' }}">

    <label for="name">Name:</label>
    <input type="text" id="name" placeholder="Vehicle Name" name="name" value="{{ fleetData.name }}">

    <label for="notes">Notes:</label>
    <input type="text" id="notes" placeholder="Extra Notes" name="notes" value="{{ fleetData.notes|default:'' }}">


    <label>Features:</label>
    <div class="features-list">
      {% for feature in features %}
        {% with feature_id=feature|slugify %}
        <div class="feature-item">
          <input 
            type="checkbox" 
            id="feature-{{ feature_id }}" 
            name="features-checkbox" 
            value="{{ feature }}"
            {% if feature in fleetData.features %}checked{% endif %}
          >
          <label for="feature-{{ feature_id }}">{{ feature }}</label>
        </div>
        {% endwith %}
      {% endfor %}
    </div>

    <input type="hidden" name="features" id="features-hidden" value="{{ fleetData.features|default:'[]' }}">

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const checkboxes = document.querySelectorAll('input[name="features-checkbox"]');
        const hiddenInput = document.getElementById('features-hidden');

        function updateHiddenInput() {
          const selectedFeatures = [];
          checkboxes.forEach(cb => {
            if (cb.checked) selectedFeatures.push(cb.value);
          });
          hiddenInput.value = JSON.stringify(selectedFeatures);
        }

        updateHiddenInput();

        checkboxes.forEach(cb => {
          cb.addEventListener('change', updateHiddenInput);
        });
      });
    </script>
    <br>
    <label for="custom">Custom</label>
    <textarea name="custom" id="custom"></textarea>
    <small>This is for any extra fields you want<br>expected format: "key"="value"<br>example: "Destination Controller": "ICU602"</small>

    <br>

    <label for="summary">Summary:</label>
    <textarea id="summary" name="summary" rows="5">{{ fleetData.summary }}</textarea>

    <button type="submit" class="btn">Save Changes</button>
  </form>
</div>

{% endwith %}

<script>
  $(document).ready(function() {
    function formatLivery(livery) {
      if (!livery.id) return livery.text;

      const $option = $('#livery').find('option[value="' + livery.id + '"]');
      const leftCss = livery.left_css || $option.data('left_css') || '#ccc';

      const $container = $(`
        <div class="livery-cell" style="background: ${leftCss};"></div><span>${livery.text}</span>
      `);
      return $container;
    }
    const $operator = $('#operator');
    const isSuperuser = {{ user.is_superuser|yesno:"true,false" }};
    const userId = {{ user.id }};

    if (!isSuperuser) {
      // Normal users: static options
      $operator.select2({
        placeholder: 'Select an operator',
        allowClear: true,
        width: '100%'
      });
    } else {
      $operator.select2({
        placeholder: 'Select an operator',
        allowClear: true,
        width: '100%',
        ajax: {
          url: function (params) {
            let apiUrl = '/api/operator/';
            console.log('API URL:', apiUrl);
            console.log('Search Term:', params.term);
            console.log(params.term ? params.term.length : 0);
            let charCount = params.term ? params.term.length : 0;
            console.log('Character Count:', charCount);
            if (charCount < 2) {
              apiUrl += '?user=' + userId;
            }
            return apiUrl;
          },


          dataType: 'json',
          delay: 250,
          data: function (params) {
            return {
              limit: 100,
              offset: params.page ? params.page * 100 : 0,
              operator_name__icontains: params.term || ''
            };
          },
          processResults: function (data, params) {
            params.page = params.page || 0;

            return {
              results: data.results.map(function (operator) {
                return {
                  id: operator.id,
                  text: operator.operator_name,
                };
              }),
              pagination: {
                more: data.next !== null
              }
            };
          },
          cache: true
        },
        language: {
          inputTooShort: function () {
            return ''; // hide "type more characters" text
          },
          searching: function () {
            return 'Searching...';
          }
        }
      });
    }
    $('#loan_operator').select2({
      placeholder: 'Select a loan operator',
      allowClear: true,
      width: '100%'
    });
    $('#livery').select2({
      placeholder: 'Select a livery',
      allowClear: true,
      width: '100%',
      templateResult: formatLivery,
      templateSelection: formatLivery,
      ajax: {
        url: '/api/liveries/',
        dataType: 'json',
        delay: 250,
        data: function (params) {
          return {
            limit: 100,
            offset: params.page ? params.page * 100 : 0,
            name__icontains: params.term || ''
          };
        },
        processResults: function (data, params) {
          params.page = params.page || 0;

          return {
            results: data.results.map(function(livery) {
              return {
                id: livery.id,
                text: livery.name,
                left_css: livery.left_css
              };
            }),
            pagination: {
              more: data.next !== null
            }
          };
        },
        cache: true
      },
      minimumInputLength: 0
    });
    $('#type').select2({
      placeholder: 'Select a type',
      allowClear: true,
      width: '100%',
      ajax: {
        url: '/api/type/',
        dataType: 'json',
        delay: 250,
        data: function (params) {
          return {
            limit: 100,
            offset: params.page ? params.page * 100 : 0,
            type_name_contains: params.term || ''
          };
        },
        processResults: function (data, params) {
          params.page = params.page || 0;

          return {
            results: data.results.map(function(type) {
              return {
                id: type.id,
                text: type.type_name,
              };
            }),
            pagination: {
              more: data.next !== null
            }
          };
        },
        cache: true
      },
      minimumInputLength: 0
    });
    $('#type').next('.select2-container').find('.select2-selection--single').addClass('custom-type-radius');
    $('#type').on('select2:open', function() {
      $('.select2-dropdown').css('border-radius', '0 0 .5em .5em');
    });
  });
</script>
<script>
  function createVehicleTableRows(count) {
    const tbody = document.querySelector('#vehicle-table tbody');
    tbody.innerHTML = '';

    for (let i = 1; i <= count; i++) {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td><input type="text" name="fleet_number_${i}" id="fleet_number_${i}"></td>
        <td><input type="text" name="reg_${i}" id="reg_${i}"></td>
      `;

      tbody.appendChild(row);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const numberInput = document.getElementById('number_of_vehicles');
    createVehicleTableRows(parseInt(numberInput.value) || 1);

    numberInput.addEventListener('input', function () {
      const count = parseInt(this.value);
      if (count > 0 && count <= 50) {
        createVehicleTableRows(count);
      } else if (count > 50) {
        alert("Please enter a number less than or equal to 50.");
        this.value = 50;
        createVehicleTableRows(50);
      } else {
        this.value = 1;
        createVehicleTableRows(1);
      }
    });
  });

function autoFillFleetNumbers() {
  const count = parseInt(document.getElementById('number_of_vehicles').value);
  const firstValue = document.getElementById('fleet_number_1').value;

  // Validate alphanumeric format: prefix + digits
  const match = firstValue.match(/^([a-zA-Z]*)(\d+)$/);
  if (!match) {
    alert("Please enter a fleet number with a prefix followed by digits, like 'BUS001'.");
    return;
  }

  const prefix = match[1]; // e.g., 'BUS'
  const startNumber = parseInt(match[2], 10); // e.g., 1
  const numberLength = match[2].length; // e.g., 3 (for padding)

  for (let i = 0; i < count; i++) {
    const input = document.getElementById(`fleet_number_${i + 1}`);
    if (input) {
      const number = (startNumber + i).toString().padStart(numberLength, '0');
      input.value = `${prefix}${number}`;
    }
  }
}


  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('autofill-btn').addEventListener('click', autoFillFleetNumbers);
  });

  function incrementRegSuffix(suffix, increment) {
    const base = 'ABCDEFGHJKLMNOPRSTUVWXYZ';
    let chars = suffix.toUpperCase().split('');

    for (let i = 0; i < increment; i++) {
      for (let j = chars.length - 1; j >= 0; j--) {
        let idx = base.indexOf(chars[j]);
        if (idx === -1) return null;

        if (idx < base.length - 1) {
          chars[j] = base[idx + 1];
          break;
        } else {
          chars[j] = base[0];
          if (j === 0) {
            return null; // overflow
          }
        }
      }
    }

    return chars.join('');
  }

function autoFillRegistrations() {
  const count = parseInt(document.getElementById('number_of_vehicles').value);
  const firstRegInput = document.getElementById('reg_1');
  const firstReg = firstRegInput.value.trim().toUpperCase();

  const match = firstReg.match(/^([A-Z]{2}\d{2})\s([A-Z]{3})$/);
  if (!match) {
    alert("Please enter a registration in the format like 'YX14 FDD'.");
    return;
  }

  const prefix = match[1];
  const suffix = match[2];

  let offset = 0;
  let filled = 0;

  while (filled < count) {
    const newSuffix = incrementRegSuffix(suffix, offset);
    offset++;

    if (!newSuffix) {
      alert("Cannot generate registration past the legal suffix range.");
      return;
    }

    const fullReg = `${prefix} ${newSuffix}`;
    const fifthChar = fullReg.charAt(4); // 5th character of full reg

    // ❌ Skip if 2nd letter of suffix matches the 5th character of the full registration
    if (newSuffix[1] === fifthChar) {
      continue;
    }

    const input = document.getElementById(`reg_${filled + 1}`);
    if (input) {
      input.value = fullReg;
    }

    filled++;
  }
}



  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('autofill-reg-btn').addEventListener('click', autoFillRegistrations);
  });
</script>

{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/select2.css' %}">
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
{% endblock %}