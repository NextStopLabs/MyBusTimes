{% extends 'mbtbase.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
  .page {
    width: 100%;
  }

  @media (min-width: 48em) {
    .chips {
      grid-template-columns: none;
    }

    .panes {
      justify-content: space-between;
      margin: -1em 0;
      display: flex;
    }

    .pane {
      width: calc(50% - 10px);
    }

.discord-widget {
  width: 300px;
  max-height: 400px;
  margin: 20px auto;
  padding: 10px;
  background: #243447;
  border-radius: 10px;
  box-shadow: 0 0 5px rgba(0,0,0,0.2);
  overflow-y: auto;
}

.discord-widget h2 {
  text-align: center;
  margin-bottom: 12px;
  font-size: 1.2em;
  color: #aad4ff;
}

.member-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.member {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #2f4a5a;
  padding: 6px 8px;
  border-radius: 6px;
}

.member img {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1px solid #aad4ff;
}

.member span {
  font-size: 0.85em;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

  }
</style>
{% endblock %}

{% block title %}Home{% endblock %}

{% block content %}

<h2>Message of The Day</h2>
<p>{{ message }}</p>
<h2>Search</h2>
<p>Search for operators or routes</p>
<div class="homeSearch">
  <form action="search">
    <input type="search" name="q" id="q" placeholder="Search">
    <input type="submit" value="Search">
  </form>
</div>
<div class="status" id="status-home" style="display: none;">
    <div id="content" class="grid" aria-live="polite"></div>
</div>
<script src="{% static 'js/status-home.js' %}"></script>
<br>
<div class="ad-box" id="body-ad-1"></div>
<div class="panes">
  <div class="pane">
    <div class="helpful-links">
      <h2>Quick Links</h2>
      <ul class="chips">
        <li class="chip">
          {% if request.user.is_authenticated %}
          <a id="profile" href="/u/{{ request.user.username }}">My Profile</a>
          {% else %}
          <a id="profile" href="/account/login">Login</a>
          {% endif %}
        </li>
        {% if admin %}
        <li class="chip"><a href="/admin/">Admin Portal</a></li>
        {% endif %}
        <li class="chip"><a href="/operator/create/">Create A Company</a></li>
        <li class="chip"><a href="/create/livery">Create A Livery</a></li>
        <li class="chip"><a href="/create/vehicle">Request Vehicle Type</a></li>
        <!--<li class="chip"><a href="https://ticketer.mybustimes.cc">Ticketer (Alpha Demo)</a></li>-->
        <li class="chip for-sale-chip">
          <a href="/for_sale/">For Sale Vehicles</a>
          <span class="dot-badge">{{ for_sale_vehicles }}</span>
        </li>
        <li class="chip"><a href="/displays/">Bus Displays</a></li>
      </ul>
    </div>
  </div>
  <div class="pane">
    <h2>&nbsp;</h2>
    <ul class="chips">
     {% if user.is_superuser %}
        <li class="chip"><a href="/api-admin/">Admin API Portal</a></li>
        {% endif %}
      <li class="chip"><a href="/forum/">Forums</a></li>
      <li class="chip"><a href="/wiki/">Wiki</a></li>
      <li class="chip"><a href="/message/">Messages</a></li>
      <li class="chip"><a href="/tickets/">Open a Ticket</a></li>
      <li class="chip"><a href="/report">Bug Report</a></li>
      <li class="chip"><a href="/hub/">Community Hub</a></li>
    </ul>

  </div>
</div>
</div>

<br>

<online>
    <style>
      online {
        display: block;
        max-width: 600px;
        margin: 1rem auto;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        text-align: center;
      }

      online strong {
        padding: 0.8rem;
        display: block;
      }

      online table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* equal column widths */
      }

      online thead {
        background-color: var(--brand-color-darker);
      }

      online th,
      online td {
        padding: 0.8rem;
        text-align: center !important;
        border: 1px solid var(--border-color);
        width: 25%;
        word-wrap: break-word;
      }

      online tbody td span {
        font-weight: 600;
        color: var(--text-color);
      }

      /* alternating row for subtle contrast */
      online tbody tr:nth-child(even) {
        background-color: var(--brand-color-darker);
      }

      /* --- MOBILE VIEW --- */
      @media (max-width: 600px) {
        online table,
        online thead,
        online tbody,
        online th,
        online td,
        online tr {
          display: block;
          width: 100%;
        }

        online thead {
          display: none;
        }

        online tbody tr {
          display: flex;
          flex-direction: column;
          gap: 0.4rem;
          padding: 0.8rem 1rem;
          background-color: var(--brand-color-darker);
          border-bottom: 1px solid var(--border-color);
        }

        /* Each cell becomes a "label: value" pair */
        online tbody td {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border: none;
          padding: 0.3rem 0 !important;
          background: none;
          text-align: left !important;
          max-width: calc(100% - 2rem);
          border-bottom: 1px solid var(--brand-color-darker-darker);
        }

        online tbody td::before {
          content: attr(data-label);
          font-weight: 600;
        }

        online tbody td span {
          text-align: right;
          font-weight: 600;
        }
      }
    </style>

    <strong style="background: var(--border-color);">Come say hi on in the <a href="/forum/">forums</a> or on <a href="/a/discord/">discord</a></strong>
    <table>
      <thead>
        <tr>
          <td>Online</td>
          <td>Total</td>
          <td>Discord Online</td>
          <td>Discord Total</td>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td data-label="Online"><span id="online-users">–</span></td>
          <td data-label="Total"><span id="total-users">–</span></td>
          <td data-label="Discord Online"><span id="discord-online">–</span></td>
          <td data-label="Discord Total"><span id="discord-total">–</span></td>
        </tr>
        <tr style="background: var(--background-color); text-align: center; display: block;">
          <td colspan="2" id="website-user-goal" style="text-align: center; display: block;"></td>
          <td colspan="2" id="discord-user-goal" style="text-align: center; display: block;"></td>
        </tr>
      </tbody>
    </table>

    <script>
      const onlineUsersEl = document.getElementById("online-users");
      const totalUsersEl = document.getElementById("total-users");
      const discordOnlineEl = document.getElementById("discord-online");
      const discordTotalEl = document.getElementById("discord-total");
      const websiteGoalEl = document.getElementById("website-user-goal");
      const discordGoalEl = document.getElementById("discord-user-goal");
      const discordgoal = 1000;
      const websitegoal = 3000;
    

      fetch("/api/online-members/", { method: "GET" })
        .then(response => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.json();
        })
        .then(data => { 
          const websitememberstogo = websitegoal - data.total_mbt_members
          const discordmemberstogo = discordgoal - data.total_discord_members          
          onlineUsersEl.textContent = data.online_mbt_members ?? "—";
          totalUsersEl.textContent = data.total_mbt_members ?? "—";
          discordOnlineEl.textContent = data.online_discord_members ?? "—";
          discordTotalEl.textContent = data.total_discord_members ?? "—";
          websiteGoalEl.textContent = `${websitememberstogo} Website members to go`  
          discordGoalEl.textContent = `${discordmemberstogo} Discord members to go`
        })
        .catch(error => console.error("Fetch error:", error));
    </script>
    <strong>At 3000 MBT members and 1000 Discord members, you will be able to vote what colour to dye <a href="/u/Kai/">Kai's</a> hair</strong>
  </online>
  <p>
  Note: MyBusTimes is a fictional and community-run transport database.<br>
  All data shown here is user generated and not real world data <a href="/about">more info</a>.
</p>
<div class="ad-box" id="body-ad-2"></div>
<div id="regions-container">
  {% regroup regions by region_country as country_list %}

  {% for country in country_list %}
  <div>
    <h2>{{ country.grouper }}</h2>
    <ul>
      {% for region in country.list %}
      <li><a href="/region/{{ region.region_code }}">{{ region.region_name }}</a></li>
      {% endfor %}
    </ul>
  </div>
  {% endfor %}
</div>
{% endblock %}