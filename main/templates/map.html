{% extends 'mbtbase.html' %}
{% load static %}

{% block title %}Live Route Map{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  html,
  body,
  main {
    overflow: hidden;
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #map {
    position: fixed !important;
    top: 55px;
    bottom: 0;
    width: 100%;
    left: 0;
  }

  .maplibregl-popup-content {
    font-size: 14px;
    color: black;
  }

  .vehicle-marker {
    text-align: center;
    color: #000;
    fill: currentColor;
    text-anchor: middle;
    paint-order: stroke;
    stroke-width: 2px;
    line-height: 16px;
  }

  .bt-toggle-control {
    background: var(--background-color);
    padding: 6px 8px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    color: var(--text-color);
    position: absolute;
    top: 65px;
    right: 10px;
    z-index: 10;
  }

  .maplibregl-popup-tip,
  .maplibregl-popup-content {
    background: var(--background-color) !important;
    color: var(--text-color) !important;
    border-radius: 0.5em !important;
    font-size: 12px !important;
  }

  small, p {
    margin: 0;
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
{% endblock %}

{% block content %}
<div id="map"></div>
<div id="timer" style="display:none"></div>

<script>
  const savedView = JSON.parse(localStorage.getItem('mbt_map_view') || 'null');

  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.maptiler.com/maps/streets-v4/style.json?key=ghAzCSy39lRpGskkQ68J',
    center: savedView?.center || [-1.9, 54.9],
    zoom: savedView?.zoom || 5                
  });

  // Save user view on move
  map.on('moveend', () => {
    const center = map.getCenter();
    const zoom = map.getZoom();
    localStorage.setItem(
      'mbt_map_view',
      JSON.stringify({ center: [center.lng, center.lat], zoom })
    );
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-left');

  function timeAgo(dateString) {
    if (!dateString) return '';
    const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
    if (seconds < 60) return `${seconds} sec${seconds !== 1 ? 's' : ''} ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} min${minutes !== 1 ? 's' : ''} ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hr${hours !== 1 ? 's' : ''} ago`;
    const days = Math.floor(hours / 24);
    return `${days} day${days !== 1 ? 's' : ''} ago`;
  }

  function createLiveryIcon({ label = '', rotation = 0, bg = '#0000', css = null, textColour = '#fff', textStroke = "#0000", strokeWidth = "0px" } = {}) {
    const normalisedRotation = ((rotation % 360) + 360) % 360;
    const cellRotation = (normalisedRotation < 90 || normalisedRotation > 270) ? 0 : 180;
    const backgroundStyle = css ? `background: ${css};` : `background: ${bg};`;
    const html = document.createElement('div');
    html.innerHTML = `
      <div style="display:inline-block; transform: rotate(${rotation}deg);">
        <svg width="24" height="16" data-vehicle-id="51623" class="vehicle-marker" style="stroke: ${textStroke}; text-align: center; ${backgroundStyle} transform: rotate(${cellRotation}deg); border: 1px solid rgba(0,0,0,0.4); color: ${textColour}; fill: ${textColour}; stroke-width: ${strokeWidth};">
          <text x="12" y="12">${label}</text>
        </svg>
        <span style="display:flex; margin-top: -27px; margin-left: 16px; color:black;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 6.65v10.69c0 .64.76.99 1.24.56l6.11-5.35c.34-.3.34-.83 0-1.13L9.24 6.07C8.76 5.65 8 5.99 8 6.63Z" />
          </svg>
        </span>
      </div>
    `;

    return html;
  }




  const vehicleMarkers = [];
  const stopMarkers = [];
  const btMarkers = [];

  function clearMarkers(list) {
    while (list.length) {
      const m = list.pop();
      m.remove();
    }
  }

  async function refreshMarkers() {
    try {
      const res = await fetch('/api/active_trips/');
      const data = await res.json();
      const vehicles = data.results || data || [];

      // 1️⃣ Track open popup
      const openPopup = document.querySelector('.maplibregl-popup');
      const openVehicleId = openPopup?.__vehicleId || null;

      // 2️⃣ Loop through all vehicles
      for (const v of vehicles) {
        const tracking = v.tracking_data || v.tracking || {};
        const lat = tracking.X ?? tracking.lat ?? tracking.latitude;
        const lng = tracking.Y ?? tracking.lon ?? tracking.longitude;
        if (!lat || !lng) continue;

        const id = v.id || v.tracking_vehicle?.id;
        if (!id) continue;

        const heading = tracking.heading ?? tracking.bearing ?? 0;
        const routeNum = v.tracking_route?.route_num || v.route || '?';
        const veh = v.tracking_vehicle || {};
        const liveryCss = veh.livery?.left_css || veh.livery?.css || veh.livery?.colour || null;
        const textColour = veh.livery?.text_colour || '#000';

        // 3️⃣ Marker already exists? Just move and rotate it.
        if (vehicleMarkers[id]) {
          const marker = vehicleMarkers[id];
          const el = marker.getElement();

          // Smoothly interpolate the marker position
          const oldPos = marker.getLngLat();
          const newPos = [lng, lat];

          // Animate the movement
          const startTime = performance.now();
          const duration = 500; // half a second
          const animate = (time) => {
            const t = Math.min(1, (time - startTime) / duration);
            const lngInterp = oldPos.lng + (newPos[0] - oldPos.lng) * t;
            const latInterp = oldPos.lat + (newPos[1] - oldPos.lat) * t;
            marker.setLngLat([lngInterp, latInterp]);
            if (t < 1) requestAnimationFrame(animate);
          };
          requestAnimationFrame(animate);

          // Update rotation instantly
          el.querySelector('svg').style.transform = `rotate(${heading}deg)`;
        } else {
          // 4️⃣ Create marker if it doesn’t exist
          const el = createLiveryIcon({
            label: String(routeNum),
            bg: veh.livery?.colour || '#ccc',
            css: liveryCss,
            textColour,
            rotation: heading
          });

          const popup = new maplibregl.Popup({ offset: 8 });
          popup.setHTML(`
            <a href="/operator/${veh.operator}/route/${v.tracking_route?.id}/">${routeNum} to ${v.tracking_end_location || ''}</a>
            <br><a href="/operator/${veh.operator}/vehicles/${veh.id}/">${veh.fleet_number || ''} - ${veh.reg || ''}</a>
            <br><span class="time-ago" data-time="${v.tracking_updated_at}">${timeAgo(v.tracking_updated_at)}</span>
            <br>Heading: ${heading}°
          `);

          const marker = new maplibregl.Marker({ element: el })
            .setLngLat([lng, lat])
            .setPopup(popup)
            .addTo(map);

          popup.on('open', () => (popup.__vehicleId = id));
          vehicleMarkers[id] = marker;
        }
      }

      // 5️⃣ Reopen popup if vehicle still exists
      if (openVehicleId && vehicleMarkers[openVehicleId]) {
        const marker = vehicleMarkers[openVehicleId];
        const popup = marker.getPopup();
        if (popup && !popup.isOpen()) popup.addTo(map);
      }

    } catch (err) {
      console.error('Vehicle marker update failed', err);
    }
  }

  async function fetchStops() {
    const zoom = map.getZoom();
    if (zoom < 15) {
      clearMarkers(stopMarkers);
      return;
    }

    const b = map.getBounds();
    const query = new URLSearchParams({
      ymax: b.getNorth(),
      ymin: b.getSouth(),
      xmax: b.getEast(),
      xmin: b.getWest()
    }).toString();

    try {
      const res = await fetch(`https://ukbuses.org/stops.json?${query}`);
      const data = await res.json();
      const stops = Array.isArray(data) ? data : (data.features || []);
      clearMarkers(stopMarkers);

      for (const s of stops) {
        const coords = s.geometry?.coordinates || s.coordinates;
        if (!coords) continue;
        const [lng, lat] = coords;
        const name = s.properties?.name || s.name || `Stop ${lat.toFixed(4)},${lng.toFixed(4)}`;

        const el = document.createElement('div');
        el.style.cssText = 'width:10px;height:10px;border:3px solid #2f80ea;border-radius:50%;background:#fff;';
        const m = new maplibregl.Marker({ element: el })  // ✅ FIXED
          .setLngLat([lng, lat])
          .setPopup(new maplibregl.Popup({ offset: 6 }).setHTML(`<a href="/stop/?name=${encodeURIComponent(name)}">${name}</a>`))
          .addTo(map);
        stopMarkers.push(m);
      }
    } catch (e) {
      console.error('Stop fetch failed', e);
    }
  }

  async function fetchBTVehicles() {
    const b = map.getBounds();
    const q = new URLSearchParams({
      ymax: b.getNorth(),
      ymin: b.getSouth(),
      xmax: b.getEast(),
      xmin: b.getWest()
    }).toString();

    try {
      const res = await fetch(`https://ukbuses.org/vehicles.json?${q}`);
      const data = await res.json();
      const vehicles = Array.isArray(data) ? data : (data.features || []);
      clearMarkers(btMarkers);

      if (vehicles.length > 2000) return;

      for (const v of vehicles.slice(0, 2000)) {
        const coords = v.coordinates || v.geometry?.coordinates;
        if (!coords) continue;
        const [lng, lat] = coords;

        let heading = v.heading ?? 0;
        const line = v.service?.line_name || '';
        const serviceLink = v.service?.url || '';
        const vehicleLink = v.vehicle?.url || '';
        const dest = v.destination || '';
        const vehicleName = v.vehicle?.name || '';
        const vehicleColour = v.vehicle?.colour || '#0000';
        const whiteText = v.vehicle?.white_text ?? false;
        let textStroke = v.vehicle?.stroke_colour ?? false;
        const livery = v.vehicle?.livery || null;

        heading = heading + 180;

        rotation = heading;
        heading = heading + 90;

        const left_css = v.vehicle?.left_css || null;
        const right_css = v.vehicle?.right_css || null;

        let css = left_css;

        if (rotation > 180 && rotation < 360) {
          css = right_css;
        } else {
          css = left_css;
        }
        
        let textColour = '#000';

        if (whiteText) textColour = '#fff';

        if (v.vehicle?.text_colour) textColour = v.vehicle.text_colour;

        console.log(v.vehicle?.css)

        let strokeWidth = "0px";

        if (textStroke != false) strokeWidth = "2px";

        if (livery == null) {
          textColour = '#000';
          css = "#fff";
        }

        if (v.vehicle?.css) {
          css = v.vehicle.css;
        }

        let html = '';

        const is_staff = {{ user.is_staff|yesno:"true,false" }};
        if (is_staff) {
          html = `
          <a href="https://ukbuses.org${serviceLink}">${line} to ${dest}</a><br>
          ${vehicleName ? `<a href="https://ukbuses.org${vehicleLink}">${vehicleName}</a><br>` : ''}
          <span class="time-ago" data-time="${v.datetime}">${timeAgo(v.datetime)}</span>
          `;
        } else {
          html = `
          ${line} to ${dest}<br>
          ${vehicleName ? `${vehicleName}<br>` : ''}
          <span class="time-ago" data-time="${v.datetime}">${timeAgo(v.datetime)}</span>
          `;
        }

        const el = createLiveryIcon({
          label: line, css, textColour, rotation: heading, textStroke, strokeWidth
        });
        const m = new maplibregl.Marker({ element: el })
          .setLngLat([lng, lat])
          .setPopup(new maplibregl.Popup({ offset: 6 }).setHTML(`
            ${html}
          `))
          .addTo(map);
        btMarkers.push(m);
      }
    } catch (e) {
      console.error('BT vehicle fetch failed', e);
    }
  }

  const btDiv = document.createElement('div');
  btDiv.className = 'bt-toggle-control';
  btDiv.innerHTML = `<label><input id="btToggle" type="checkbox" checked style="margin-right:6px;">Real Buses</label>`;
  document.body.appendChild(btDiv);
  const btToggle = document.getElementById('btToggle');
  btToggle.addEventListener('change', () => {
    if (btToggle.checked) fetchBTVehicles();
    else clearMarkers(btMarkers);
  });

  refreshMarkers();
  fetchStops();
  fetchBTVehicles();

  setInterval(() => {
    refreshMarkers();
    if (btToggle.checked) fetchBTVehicles();
  }, 30000);// 30 seconds

  map.on('moveend', () => {
    fetchStops();
    if (btToggle.checked) fetchBTVehicles();
  });

  setInterval(() => {
    document.querySelectorAll('.time-ago').forEach(el => {
      const dateString = el.dataset.time;
      if (dateString) {
        el.textContent = timeAgo(dateString);
      }
    });
  }, 1000); 
</script>
{% endblock %}